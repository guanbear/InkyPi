<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div class="form-group">
    <label class="form-label">QWeather API Configuration: </label>
    <div class="form-group">
        <span>API Host </span>
        <input type="text" id="qweatherHost" name="qweatherHost" class="form-input" placeholder="https://devapi.qweather.com" />
        <small style="display: block; margin-top: 5px; color: #666;">
            留空则使用 .env 文件中的 QWEATHER_HOST 配置<br>
            开发版: https://devapi.qweather.com (免费，每天1000次)<br>
            商业版: https://api.qweather.com
        </small>
    </div>
</div>

<div class="form-group">
    <label class="form-label">Location: </label>
    <div class="form-group">
        <span>Latitude </span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span>Longitude </span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <button type="button" id="openMap" class="action-button compact">Select Location</button>
</div>

<div class="form-group">
    <label for="units" class="form-label">Units:</label>
    <select id="units" name="units" class="form-input">
        <option value="metric">Metric (°C)</option>
        <option value="imperial">Imperial (°F)</option>
    </select>
</div>

<div class="form-group">
    <label for="language" class="form-label">Language:</label>
    <select id="language" name="language" class="form-input">
        <option value="zh">中文</option>
        <option value="en">English</option>
    </select>
</div>

<div class="form-group">
    <label for="hourlySource" class="form-label">Hourly Forecast Source:</label>
    <select id="hourlySource" name="hourlySource" class="form-input">
        <option value="qweather">QWeather (和风天气)</option>
        <option value="caiyun">Caiyun Weather (彩云天气)</option>
    </select>
    <small style="display: block; margin-top: 5px; color: #666;">
        彩云天气2小时内预报更准确，需在 .env 配置 CAIYUN_API_KEY
    </small>
</div>

<div class="form-group">
    <label for="themeMode" class="form-label">Theme Mode:</label>
    <select id="themeMode" name="themeMode" class="form-input">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="auto">Auto (based on sunrise/sunset)</option>
    </select>
</div>

<div class="form-group">
    <label for="displayStyle" class="form-label">Display Style:</label>
    <select id="displayStyle" name="displayStyle" class="form-input">
        <option value="default">Default</option>
        <option value="nothing">Nothing Weather (Pixel)</option>
    </select>
</div>

<div class="form-group">
    <label class="form-label">Title:</label>
    <input type="text" id="customTitle" name="customTitle" class="form-input" placeholder="留空则显示城市名称" />
</div>

<div class="form-group">
    <label for="displayMetrics" class="form-label">Display: </label>

    <div class="form-group">
      <input type="checkbox" id="displayRefreshTime" name="displayRefreshTime" onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Refresh Time</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayMetrics" name="displayMetrics" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Metrics</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayGraph" name="displayGraph" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Weather Graph</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayRain" name="displayRain" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Rain Amount</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="moonPhase" name="moonPhase" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Moon Phase</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayForecast" name="displayForecast" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Forecast</span>
        <select id="forecastDays" name="forecastDays" class="form-input">
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=7>7</option>
        </select>
        <span>days</span>
    </div>
</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">×</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div id="map" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $mapModal = document.querySelector('#mapModal');
        const $closeMap = document.querySelector('#closeMap');

        let latitude = +$latitude.value || 39.9042;
        let longitude = +$longitude.value || 116.4074;
        let zoom = $latitude.value ? 4.5 : 4;

        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal')
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([latitude, longitude], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

                    map.on('click', event => {
                        marker.setLatLng(event.latlng);
                    });
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            $latitude.value = position.lat;
            $longitude.value = position.lng;
            closeModal('mapModal');
        });

        if (loadPluginSettings) {
            document.getElementById('qweatherHost').value = pluginSettings.qweatherHost || '';
            document.getElementById('latitude').value = pluginSettings.latitude || '39.9042';
            document.getElementById('longitude').value = pluginSettings.longitude || '116.4074';
            document.getElementById('units').value = pluginSettings.units || 'metric';
            document.getElementById('language').value = pluginSettings.language || 'zh';
            document.getElementById('hourlySource').value = pluginSettings.hourlySource || 'qweather';
            document.getElementById('themeMode').value = pluginSettings.themeMode || 'auto';
            document.getElementById('displayStyle').value = pluginSettings.displayStyle || 'default';

            document.getElementById('displayRefreshTime').checked = pluginSettings.displayRefreshTime === 'true' || pluginSettings.displayRefreshTime === true;
            document.getElementById('displayRefreshTime').value = (pluginSettings.displayRefreshTime !== undefined && pluginSettings.displayRefreshTime !== null) ? pluginSettings.displayRefreshTime : 'true';

            document.getElementById('displayMetrics').checked = pluginSettings.displayMetrics === 'true' || pluginSettings.displayMetrics === true;
            document.getElementById('displayMetrics').value = (pluginSettings.displayMetrics !== undefined && pluginSettings.displayMetrics !== null) ? pluginSettings.displayMetrics : 'true';

            document.getElementById('displayGraph').checked = pluginSettings.displayGraph === 'true' || pluginSettings.displayGraph === true;
            document.getElementById('displayGraph').value = (pluginSettings.displayGraph !== undefined && pluginSettings.displayGraph !== null) ? pluginSettings.displayGraph : 'true';

            document.getElementById('displayRain').checked = pluginSettings.displayRain === 'true' || pluginSettings.displayRain === true;
            document.getElementById('displayRain').value = (pluginSettings.displayRain !== undefined && pluginSettings.displayRain !== null) ? pluginSettings.displayRain : 'true';

            document.getElementById('displayForecast').checked = pluginSettings.displayForecast === 'true' || pluginSettings.displayForecast === true;
            document.getElementById('displayForecast').value = (pluginSettings.displayForecast !== undefined && pluginSettings.displayForecast !== null) ? pluginSettings.displayForecast : 'true';

            document.getElementById('forecastDays').value = pluginSettings.forecastDays || 7;

            document.getElementById('moonPhase').checked = pluginSettings.moonPhase === 'true' || pluginSettings.moonPhase === true;
            document.getElementById('moonPhase').value = (pluginSettings.moonPhase !== undefined && pluginSettings.moonPhase !== null) ? pluginSettings.moonPhase : 'false';

            document.getElementById('customTitle').value = pluginSettings.customTitle || '';
        } else {
            document.getElementById('qweatherHost').value = '';
            document.getElementById('latitude').value = '39.9042';
            document.getElementById('longitude').value = '116.4074';
            document.getElementById('units').value = "metric";
            document.getElementById('language').value = "zh";
            document.getElementById('hourlySource').value = "qweather";
            document.getElementById('themeMode').value = "auto";
            document.getElementById('displayStyle').value = "default";
            document.getElementById('displayRefreshTime').checked = true;
            document.getElementById('displayRefreshTime').value = "true";
            document.getElementById('displayMetrics').checked = true;
            document.getElementById('displayMetrics').value = "true";
            document.getElementById('displayGraph').checked = true;
            document.getElementById('displayGraph').value = "true";
            document.getElementById('displayRain').checked = true;
            document.getElementById('displayRain').value = "true";
            document.getElementById('displayForecast').checked = true;
            document.getElementById('displayForecast').value = "true";
            document.getElementById('forecastDays').value = 7;
            document.getElementById('moonPhase').checked = false;
        }
    });
</script>
