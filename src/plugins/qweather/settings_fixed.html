<script>

    window._AMapSecurityConfig = {
        securityJsCode: "92cd06d2544958bb607195395e62eeb9"
    };


<div class="form-group">
    <label for="language" class="form-label">
        <span id="languageLabel">üåê Language</span>
    </label>
    <select id="language" name="language" class="form-input">
        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
        <option value="en">üá∫üá∏ English</option>
    </select>
</div>

<div class="form-group">
    <label class="form-label" id="locationLabel">üìç Location</label>
    <div class="form-group">
        <span id="latitudeLabel">Latitude</span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span id="longitudeLabel">Longitude</span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="button" id="getLocationByIP" class="action-button compact">üìç Get Location by IP</button>
        <button type="button" id="openMap" class="action-button compact">üó∫Ô∏è Select on Map</button>
        <button type="button" id="setDefault" class="action-button compact">‚≠ê Set as Default</button>
    </div>
</div>

<div class="form-group">
    <label for="units" class="form-label" id="unitsLabel">üå°Ô∏è Units</label>
    <select id="units" name="units" class="form-input">
        <option value="metric">Metric (¬∞C)</option>
        <option value="imperial">Imperial (¬∞F)</option>
    </select>
</div>

<div class="form-group">
    <label for="themeMode" class="form-label" id="themeModeLabel">üé® Theme Mode</label>
    <select id="themeMode" name="themeMode" class="form-input">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="auto">Auto (based on sunrise/sunset)</option>
    </select>
</div>

<div class="form-group">
    <label for="displayStyle" class="form-label" id="displayStyleLabel">üñºÔ∏è Display Style</label>
    <select id="displayStyle" name="displayStyle" class="form-input">
        <option value="default">Default</option>
        <option value="nothing">Nothing Weather (Pixel)</option>
        <option value="qweather">QWeather Official</option>
    </select>
</div>

<div class="form-group">
    <label class="form-label" id="titleLabel">üìù Title</label>
    <input type="text" id="customTitle" name="customTitle" class="form-input" placeholder="Leave empty to show city name" />
</div>

<div class="form-group">
    <label class="form-label" id="debugLabel">üêõ Debug Weather Alert</label>
    <div class="form-group">
        <input type="text" id="mockAlertHeadline" name="mockAlertHeadline" class="form-input" placeholder="Alert headline (leave empty for real alerts)" />
    </div>
    <div class="form-group">
        <span id="severityLabel">Severity:</span>
        <select id="mockAlertSeverity" name="mockAlertSeverity" class="form-input">
            <option value="">None (Use Real)</option>
            <option value="minor">Minor</option>
            <option value="moderate">Moderate</option>
            <option value="severe">Severe</option>
            <option value="extreme">Extreme</option>
        </select>
    </div>
</div>

<div class="form-group">
    <label for="displayMetrics" class="form-label" id="displayLabel">üëÅÔ∏è Display Options</label>

    <div class="form-group">
      <input type="checkbox" id="displayRefreshTime" name="displayRefreshTime" onclick="this.value=this.checked ? 'true' : 'false';">
      <span id="refreshTimeLabel">Refresh Time</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayMetrics" name="displayMetrics" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="metricsLabel">Metrics</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayGraph" name="displayGraph" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="graphLabel">Weather Graph</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayRain" name="displayRain" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="rainLabel">Rain Amount</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="mergeMinutelyData" name="mergeMinutelyData" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="mergeMinutelyDataLabel">Merge Minutely Precipitation</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="moonPhase" name="moonPhase" onclick="this.value=this.checked ? 'true' : 'false'; toggleAirQualityOption();">
        <span id="moonPhaseLabel">Moon Phase</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="showAirQuality" name="showAirQuality" onclick="this.value=this.checked ? 'true' : 'false'; toggleMoonPhaseOption();">
        <span id="showAirQualityLabel">Air Quality</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="temperatureBars" name="temperatureBars" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="temperatureBarsLabel">Temperature Bars</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayForecast" name="displayForecast" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="forecastLabel">Forecast</span>
        <select id="forecastDays" name="forecastDays" class="form-input">
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=7>7</option>
        </select>
        <span id="daysLabel">days</span>
    </div>
</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">√ó</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div class="form-group" style="display: flex; gap: 10px;">
            <input type="text" id="searchInput" placeholder="Search for a location..." class="form-input" style="flex: 1;" />
            <button type="button" id="searchButton" class="action-button compact">Search</button>
        </div>
        <div id="searchResults" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; margin-top: 5px; display: none;"></div>
        <div id="map" style="width: 100%; height: 300px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>


    // i18n translations
    const translations = {
        en: {
            languageLabel: 'üåê Language',
            locationLabel: 'üìç Location',
            latitudeLabel: 'Latitude',
            longitudeLabel: 'Longitude',
            selectLocation: 'Select Location',
            getLocationByIP: 'üìç Get Location by IP',
            selectOnMap: 'üó∫Ô∏è Select on Map',
            setAsDefault: '‚≠ê Set as Default',
            searchPlaceholder: 'Search for a location...',
            searchButton: 'Search',
            unitsLabel: 'üå°Ô∏è Units',
            themeModeLabel: 'üé® Theme Mode',
            themeLight: 'Light',
            themeDark: 'Dark',
            themeAuto: 'Auto (based on sunrise/sunset)',
            displayStyleLabel: 'üñºÔ∏è Display Style',
            styleDefault: 'Default',
            styleNothing: 'Nothing Weather (Pixel)',
            styleQweather: 'QWeather Official',
            titleLabel: 'üìù Title',
            titlePlaceholder: 'Leave empty to show city name',
            debugLabel: 'üêõ Debug Weather Alert',
            alertHeadlinePlaceholder: 'Alert headline (leave empty for real alerts)',
            severityLabel: 'Severity:',
            severityNone: 'None (Use Real)',
            severityMinor: 'Minor',
            severityModerate: 'Moderate',
            severitySevere: 'Severe',
            severityExtreme: 'Extreme',
            displayLabel: 'üëÅÔ∏è Display Options',
            refreshTimeLabel: 'Refresh Time',
            metricsLabel: 'Metrics',
            graphLabel: 'Weather Graph',
            rainLabel: 'Rain Amount',
            mergeMinutelyDataLabel: 'Merge Minutely Precipitation',
            moonPhaseLabel: 'Moon Phase',
            showAirQualityLabel: 'Air Quality',
            temperatureBarsLabel: 'Temperature Bars',
            forecastLabel: 'Forecast',
            daysLabel: 'days',
            modalTitle: 'Select Location',
            saveButton: 'Save',
            enterKeyword: 'Please enter a search keyword',
            noResults: 'No results found',
            mapLoadFailed: 'Map library failed to load. Please refresh the page.',
            mapCreateFailed: 'Failed to create map: '
        },
        zh: {
            languageLabel: 'üåê ËØ≠Ë®Ä',
            locationLabel: 'üìç ‰ΩçÁΩÆ',
            latitudeLabel: 'Á∫¨Â∫¶',
            longitudeLabel: 'ÁªèÂ∫¶',
            selectLocation: 'ÈÄâÊã©‰ΩçÁΩÆ',
            getLocationByIP: 'üìç ÈÄöËøáIPËé∑Âèñ‰ΩçÁΩÆ',
            selectOnMap: 'ÔøΩÂõæ Âú®Âú∞Âõæ‰∏äÈÄâÊã©',
            setAsDefault: '‚≠ê ËÆæ‰∏∫ÈªòËÆ§',
            searchPlaceholder: 'ÊêúÁ¥¢Âú∞ÁÇπ...',
            searchButton: 'ÊêúÁ¥¢',
            unitsLabel: 'üå°Ô∏è Âçï‰Ωç',
            themeModeLabel: 'üé® ‰∏ªÈ¢òÊ®°Âºè',
            themeLight: 'ÊµÖËâ≤',
            themeDark: 'Ê∑±Ëâ≤',
            themeAuto: 'Ëá™Âä®ÔºàÂü∫‰∫éÊó•Âá∫Êó•ËêΩÔºâ',
            displayStyleLabel: 'üñºÔ∏è ÊòæÁ§∫È£éÊ†º',
            styleDefault: 'ÈªòËÆ§',
            styleNothing: 'NothingÂ§©Ê∞îÔºàÂÉèÁ¥†È£éÔºâ',
            styleQweather: 'ÂíåÈ£éÂ§©Ê∞îÂÆòÊñπ',
            titleLabel: 'üìù Ê†áÈ¢ò',
            titlePlaceholder: 'ÁïôÁ©∫ÂàôÊòæÁ§∫ÂüéÂ∏ÇÂêçÁß∞',
            debugLabel: 'üêõ Ë∞ÉËØïÂ§©Ê∞îÈ¢ÑË≠¶',
            alertHeadlinePlaceholder: 'È¢ÑË≠¶Ê†áÈ¢òÔºàÁïôÁ©∫‰ΩøÁî®ÁúüÂÆûÈ¢ÑË≠¶Ôºâ',
            severityLabel: '‰∏•ÈáçÁ®ãÂ∫¶:',
            severityNone: 'Êó†Ôºà‰ΩøÁî®ÁúüÂÆûÔºâ',
            severityMinor: 'ËΩªÂæÆ',
            severityModerate: '‰∏≠Á≠â',
            severitySevere: '‰∏•Èáç',
            severityExtreme: 'ÊûÅÁ´Ø',
            displayLabel: 'üëÅÔ∏è ÊòæÁ§∫ÈÄâÈ°π',
            refreshTimeLabel: 'Âà∑Êñ∞Êó∂Èó¥',
            metricsLabel: 'Ê∞îË±°ÊåáÊ†á',
            graphLabel: 'Â§©Ê∞îÂõæË°®',
            rainLabel: 'ÈôçÊ∞¥Èáè',
            mergeMinutelyDataLabel: 'ÂêàÂπ∂ÂàÜÈíüÁ∫ßÈôçÊ∞¥Êï∞ÊçÆ',
            moonPhaseLabel: 'ÊúàÁõ∏',
            showAirQualityLabel: 'Á©∫Ê∞îË¥®Èáè',
            temperatureBarsLabel: 'Ê∏©Â∫¶Êù°',
            forecastLabel: 'Â§©Ê∞îÈ¢ÑÊä•',
            daysLabel: 'Â§©',
            modalTitle: 'ÈÄâÊã©‰ΩçÁΩÆ',
            saveButton: '‰øùÂ≠ò',
            enterKeyword: 'ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç',
            noResults: 'Êú™ÊâæÂà∞ÁªìÊûú',
            mapLoadFailed: 'Âú∞ÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢',
            mapCreateFailed: 'ÂàõÂª∫Âú∞ÂõæÂ§±Ë¥•Ôºö'
        }
    };
    let currentLang = 'zh'; // Default language

    function updateLanguage(lang) {
        console.log('Updating language to:', lang);
        currentLang = lang;
        const t = translations[lang];
        document.getElementById('languageLabel').textContent = t.languageLabel;
        document.getElementById('locationLabel').textContent = t.locationLabel;
        document.getElementById('latitudeLabel').textContent = t.latitudeLabel;
        document.getElementById('longitudeLabel').textContent = t.longitudeLabel;
        document.getElementById('getLocationByIP').textContent = t.getLocationByIP;
        document.getElementById('openMap').textContent = t.selectOnMap;
        document.getElementById('setDefault').textContent = t.setAsDefault;
        document.getElementById('searchInput').placeholder = t.searchPlaceholder;
        document.getElementById('searchButton').textContent = t.searchButton;
        document.getElementById('unitsLabel').textContent = t.unitsLabel;
        document.getElementById('themeModeLabel').textContent = t.themeModeLabel;
        document.getElementById('displayStyleLabel').textContent = t.displayStyleLabel;
        document.getElementById('titleLabel').textContent = t.titleLabel;
        document.getElementById('customTitle').placeholder = t.titlePlaceholder;
        document.getElementById('debugLabel').textContent = t.debugLabel;
        document.getElementById('mockAlertHeadline').placeholder = t.alertHeadlinePlaceholder;
        document.getElementById('severityLabel').textContent = t.severityLabel;
        document.getElementById('displayLabel').textContent = t.displayLabel;
        document.getElementById('refreshTimeLabel').textContent = t.refreshTimeLabel;
        document.getElementById('metricsLabel').textContent = t.metricsLabel;
        document.getElementById('graphLabel').textContent = t.graphLabel;
        document.getElementById('rainLabel').textContent = t.rainLabel;
        document.getElementById('mergeMinutelyDataLabel').textContent = t.mergeMinutelyDataLabel;
        document.getElementById('moonPhaseLabel').textContent = t.moonPhaseLabel;
        if (document.getElementById('showAirQualityLabel')) {
            document.getElementById('showAirQualityLabel').textContent = t.showAirQualityLabel;
        }
        document.getElementById('temperatureBarsLabel').textContent = t.temperatureBarsLabel;
        document.getElementById('forecastLabel').textContent = t.forecastLabel;
        document.getElementById('daysLabel').textContent = t.daysLabel;
        document.getElementById('modalTitle').textContent = t.modalTitle;
        document.getElementById('closeMap').textContent = t.saveButton;

        // Update theme mode options
        const themeOptions = document.querySelectorAll('#themeMode option');
        themeOptions[0].textContent = t.themeLight;
        themeOptions[1].textContent = t.themeDark;
        themeOptions[2].textContent = t.themeAuto;

        // Update display style options
        const styleOptions = document.querySelectorAll('#displayStyle option');
        styleOptions[0].textContent = t.styleDefault;
        styleOptions[1].textContent = t.styleNothing;
        styleOptions[2].textContent = t.styleQweather;

        // Update severity options
        const severityOptions = document.querySelectorAll('#mockAlertSeverity option');
        severityOptions[0].textContent = t.severityNone;
        severityOptions[1].textContent = t.severityMinor;
        severityOptions[2].textContent = t.severityModerate;
        severityOptions[3].textContent = t.severitySevere;
        document.getElementById('searchResults').style.display = 'none';
        severityOptions[4].textContent = t.severityExtreme;
    }

    function toggleAirQualityOption() {
        const moonPhaseCheckbox = document.getElementById('moonPhase');
        const airQualityCheckbox = document.getElementById('showAirQuality');
        if (moonPhaseCheckbox.checked) {
            airQualityCheckbox.checked = false;
            airQualityCheckbox.value = 'false';
        }
    }

    function toggleMoonPhaseOption() {
        const moonPhaseCheckbox = document.getElementById('moonPhase');
        const airQualityCheckbox = document.getElementById('showAirQuality');
        if (airQualityCheckbox.checked) {
            moonPhaseCheckbox.checked = false;
            moonPhaseCheckbox.value = 'false';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing...');

        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $closeMap = document.querySelector('#closeMap');
        const $language = document.querySelector('#language');
        const $getLocationByIP = document.querySelector('#getLocationByIP');
        const $setDefault = document.querySelector('#setDefault');
        const $searchInput = document.querySelector('#searchInput');
        const $searchResults = document.querySelector('#searchResults');

        console.log('Button elements found:', {
            getLocationByIP: !!$getLocationByIP,
            openMap: !!$openMap,
            setDefault: !!$setDefault
        });

        let latitude = +$latitude.value || 39.9042;
        let longitude = +$longitude.value || 116.4074;

        let map, marker;

        // Language change handler
        $language.addEventListener('change', (e) => {
            console.log('Language changed to:', e.target.value);
            updateLanguage(e.target.value);
        });

        // Get location by IP button
        $getLocationByIP.addEventListener('click', async (e) => {
            console.log('Get Location by IP button clicked');
            e.preventDefault();
            try {
                const response = await fetch('/api/amap/ip_location');
                const data = await response.json();
                console.log('IP location response:', data);

                if (data.success) {
                    $latitude.value = data.latitude;
                    $longitude.value = data.longitude;
                    latitude = data.latitude;
                    longitude = data.longitude;
                } else {
                    alert('Failed to get location: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error getting location: ' + error.message);
            }
        });

        // Set as default button
        $setDefault.addEventListener('click', async () => {
            const lat = parseFloat($latitude.value);
            const lng = parseFloat($longitude.value);

            if (!lat || !lng) {
                alert('Please set a valid location first');
                return;
            }

            try {
                const response = await fetch('/api/amap/save_default_location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Default location saved successfully!');
                } else {
                    alert('Failed to save default location: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving default location: ' + error.message);
            }
        });

        // Initialize Amap when opening modal
        $openMap.addEventListener('click', async (e) => {
            console.log('Open Map button clicked');
            e.preventDefault();

            openModal('mapModal');
            console.log('Map modal opened');

            // If no location set, try to get IP location first
            if (!latitude || !longitude || (latitude === 39.9042 && longitude === 116.4074)) {
                console.log('No location set, trying IP location...');
                try {
                    const response = await fetch('/api/amap/ip_location');
                    const data = await response.json();
                    console.log('IP location response:', data);
                    if (data.success) {
                        latitude = data.latitude;
                        longitude = data.longitude;
                        $latitude.value = latitude;
                        $longitude.value = longitude;
                        console.log('IP location obtained:', latitude, longitude);
                    }
                } catch (error) {
                    console.error('Failed to get IP location:', error);
                }
            } else {
                console.log('Using existing location:', latitude, longitude);
            }

            setTimeout(() => {
                console.log('Initializing map with center:', longitude, latitude);

                if (!map) {
                    console.log('Creating new map instance...');

                    // Use the recommended loader method for Amap v2.0
                    window.AMapLoader.load({
                            key: "92cd06d2544958bb607195395e62eeb9",
                            version: "2.0",
                            plugins: ["AMap.PlaceSearch"]
                        }).then(AMap => {
                            console.log('AMap loaded successfully');

                            // Initialize Amap
                            map = new AMap.Map('map', {
                                zoom: 12,
                                center: [longitude, latitude],
                                viewMode: '2D',
                                resizeEnable: true
                            });

                        console.log('Map created successfully');

                        // Add marker
                        marker = new AMap.Marker({
                            position: [longitude, latitude],
                            draggable: true
                        });
                        map.add(marker);
                        console.log('Marker added');

                        // Update coordinates when marker is dragged
                        marker.on('dragend', (e) => {
                            const position = marker.getPosition();
                            latitude = position.lat;
                            longitude = position.lng;
                            console.log('Marker dragged to:', latitude, longitude);
                        });

                        // Add marker on map click
                        map.on('click', (e) => {
                            const lnglat = e.lnglat;
                            marker.setPosition([lnglat.lng, lnglat.lat]);
                            latitude = lnglat.lat;
                            longitude = lnglat.lng;
                            console.log('Map clicked, marker moved to:', latitude, longitude);
                        });

                        // Initialize PlaceSearch for search button
                        const placeSearch = new AMap.PlaceSearch({
                            pageSize: 10
                        });

                        console.log('PlaceSearch initialized');

                        // Search button handler
                        const $searchButton = document.querySelector('#searchButton');
                        $searchButton.addEventListener('click', () => {
                            const keyword = $searchInput.value.trim();
                            console.log('Search clicked, keyword:', keyword);

                            if (!keyword) {
                                alert(translations[currentLang].enterKeyword);
                                return;
                            }

                            placeSearch.search(keyword, (status, result) => {
                                console.log('Search status:', status);
                                console.log('Search result:', result);

                                if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                                    const pois = result.poiList.pois;
                                    console.log('Found', pois.length, 'results');

                                    // Show search results
                                    $searchResults.innerHTML = '';
                                    $searchResults.style.display = 'block';

                                    pois.forEach((poi, index) => {
                                        const div = document.createElement('div');
                                        div.style.padding = '8px';
                                        div.style.cursor = 'pointer';
                                        div.style.borderBottom = '1px solid #eee';
                                        div.textContent = `${poi.name} - ${poi.address || ''}`;

                                        div.addEventListener('click', () => {
                                            const location = poi.location;
                                            console.log('Selected POI:', poi.name, location.lng, location.lat);
                                            map.setCenter([location.lng, location.lat]);
                                            map.setZoom(15);
                                            marker.setPosition([location.lng, location.lat]);
                                            latitude = location.lat;
                                            longitude = location.lng;
                                            $searchResults.style.display = 'none';
                                            $searchInput.value = poi.name;
                                        });

                                        $searchResults.appendChild(div);
                                    });
                                } else {
                                    console.warn('No results found or search failed');
                                    alert(translations[currentLang].noResults);
                                }
                            });
                        });

                        // Allow Enter key to trigger search
                        $searchInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                console.log('Enter key pressed');
                                $searchButton.click();
                            }
                        });
                    }).catch(error => {
                        console.error('Error loading Amap:', error);
                        alert(translations[currentLang].mapLoadFailed + ': ' + error.message);
                    });
                } else {
                    console.log('Map already exists, updating center');
                    // Map already exists, just update center
                    map.setCenter([longitude, latitude]);
                    marker.setPosition([longitude, latitude]);
                }
            }, 500); // Increased timeout to 500ms
        });

        // Save location when closing map
        $closeMap.addEventListener('click', () => {
            $latitude.value = latitude.toFixed(6);
            $longitude.value = longitude.toFixed(6);
            closeModal('mapModal');
        });

        // Load settings
        console.log('Loading plugin settings...');
        try {
            if ( typeof loadPluginSettings !== 'undefined' && loadPluginSettings) {
                document.getElementById('latitude').value = pluginSettings.latitude || '39.9042';
                document.getElementById('longitude').value = pluginSettings.longitude || '116.4074';
                document.getElementById('units').value = pluginSettings.units || 'metric';
                document.getElementById('language').value = pluginSettings.language || 'zh';
                document.getElementById('themeMode').value = pluginSettings.themeMode || 'auto';
                document.getElementById('displayStyle').value = pluginSettings.displayStyle || 'default';

                document.getElementById('displayRefreshTime').checked = pluginSettings.displayRefreshTime === 'true' || pluginSettings.displayRefreshTime === true;
                document.getElementById('displayRefreshTime').value = (pluginSettings.displayRefreshTime !== undefined && pluginSettings.displayRefreshTime !== null) ? pluginSettings.displayRefreshTime : 'true';

                document.getElementById('displayMetrics').checked = pluginSettings.displayMetrics === 'true' || pluginSettings.displayMetrics === true;
                document.getElementById('displayMetrics').value = (pluginSettings.displayMetrics !== undefined && pluginSettings.displayMetrics !== null) ? pluginSettings.displayMetrics : 'true';

                document.getElementById('displayGraph').checked = pluginSettings.displayGraph === 'true' || pluginSettings.displayGraph === true;
                document.getElementById('displayGraph').value = (pluginSettings.displayGraph !== undefined && pluginSettings.displayGraph !== null) ? pluginSettings.displayGraph : 'true';

                document.getElementById('displayRain').checked = pluginSettings.displayRain === 'true' || pluginSettings.displayRain === true;
                document.getElementById('displayRain').value = (pluginSettings.displayRain !== undefined && pluginSettings.displayRain !== null) ? pluginSettings.displayRain : 'true';

                document.getElementById('mergeMinutelyData').checked = pluginSettings.mergeMinutelyData === 'true' || pluginSettings.mergeMinutelyData === true;
                document.getElementById('mergeMinutelyData').value = (pluginSettings.mergeMinutelyData !== undefined && pluginSettings.mergeMinutelyData !== null) ? pluginSettings.mergeMinutelyData : 'false';

                document.getElementById('displayForecast').checked = pluginSettings.displayForecast === 'true' || pluginSettings.displayForecast === true;
                document.getElementById('displayForecast').value = (pluginSettings.displayForecast !== undefined && pluginSettings.displayForecast !== null) ? pluginSettings.displayForecast : 'true';

                document.getElementById('forecastDays').value = pluginSettings.forecastDays || 7;

                document.getElementById('moonPhase').checked = pluginSettings.moonPhase === 'true' || pluginSettings.moonPhase === true;
                document.getElementById('moonPhase').value = (pluginSettings.moonPhase !== undefined && pluginSettings.moonPhase !== null) ? pluginSettings.moonPhase : 'false';

                document.getElementById('showAirQuality').checked = pluginSettings.showAirQuality === 'true' || pluginSettings.showAirQuality === true;
                document.getElementById('showAirQuality').value = (pluginSettings.showAirQuality !== undefined && pluginSettings.showAirQuality !== null) ? pluginSettings.showAirQuality : 'false';

                document.getElementById('temperatureBars').checked = pluginSettings.temperatureBars === 'true' || pluginSettings.temperatureBars === true;
                document.getElementById('temperatureBars').value = (pluginSettings.temperatureBars !== undefined && pluginSettings.temperatureBars !== null) ? pluginSettings.temperatureBars : 'true';

                document.getElementById('customTitle').value = pluginSettings.customTitle || '';

                document.getElementById('mockAlertHeadline').value = pluginSettings.mockAlertHeadline || '';
                document.getElementById('mockAlertSeverity').value = pluginSettings.mockAlertSeverity || '';

                // Update language UI - default to Chinese if no saved setting
                const savedLang = pluginSettings.language || 'zh';
                document.getElementById('language').value = savedLang;
                updateLanguage(savedLang);
            } else {
                // Default settings for development mode
                document.getElementById('latitude').value = '39.9042';
                document.getElementById('longitude').value = '116.4074';
                document.getElementById('units').value = "metric";
                document.getElementById('language').value = "zh";
                document.getElementById('themeMode').value = "auto";
                document.getElementById('displayStyle').value = "default";
                document.getElementById('displayRefreshTime').checked = true;
                document.getElementById('displayRefreshTime').value = "true";
                document.getElementById('displayMetrics').checked = true;
                document.getElementById('displayMetrics').value = "true";
                document.getElementById('displayGraph').checked = true;
                document.getElementById('displayGraph').value = "true";
                document.getElementById('displayRain').checked = true;
                document.getElementById('displayRain').value = "true";
                document.getElementById('mergeMinutelyData').checked = false;
                document.getElementById('mergeMinutelyData').value = "false";
                document.getElementById('displayForecast').checked = true;
                document.getElementById('displayForecast').value = "true";
                document.getElementById('forecastDays').value = 7;
                document.getElementById('moonPhase').checked = false;
                document.getElementById('moonPhase').value = "false";
                document.getElementById('showAirQuality').checked = true;
                document.getElementById('showAirQuality').value = "true";
                document.getElementById('temperatureBars').checked = true;
                document.getElementById('temperatureBars').value = "true";
                document.getElementById('customTitle').value = '';

                document.getElementById('mockAlertHeadline').value = '';
                document.getElementById('mockAlertSeverity').value = '';

                // Initialize with Chinese
                updateLanguage('zh');
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });

</script>
<script>
    window._AMapSecurityConfig = {
        securityJsCode: "92cd06d2544958bb607195395e62eeb9"
    };
</script>

<div class="form-group">
    <label for="language" class="form-label">
        <span id="languageLabel">üåê Language</span>
    </label>
    <select id="language" name="language" class="form-input">
        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
        <option value="en">üá∫üá∏ English</option>
    </select>
</div>

<div class="form-group">
    <label class="form-label" id="locationLabel">üìç Location</label>
    <div class="form-group">
        <span id="latitudeLabel">Latitude</span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span id="longitudeLabel">Longitude</span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="button" id="getLocationByIP" class="action-button compact">üìç Get Location by IP</button>
        <button type="button" id="openMap" class="action-button compact">üó∫Ô∏è Select on Map</button>
        <button type="button" id="setDefault" class="action-button compact">‚≠ê Set as Default</button>
    </div>
</div>

<div class="form-group">
    <label for="units" class="form-label" id="unitsLabel">üå°Ô∏è Units</label>
    <select id="units" name="units" class="form-input">
        <option value="metric">Metric (¬∞C)</option>
        <option value="imperial">Imperial (¬∞F)</option>
    </select>
</div>

<div class="form-group">
    <label for="themeMode" class="form-label" id="themeModeLabel">üé® Theme Mode</label>
    <select id="themeMode" name="themeMode" class="form-input">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="auto">Auto (based on sunrise/sunset)</option>
    </select>
</div>

<div class="form-group">
    <label for="displayStyle" class="form-label" id="displayStyleLabel">üñºÔ∏è Display Style</label>
    <select id="displayStyle" name="displayStyle" class="form-input">
        <option value="default">Default</option>
        <option value="nothing">Nothing Weather (Pixel)</option>
        <option value="qweather">QWeather Official</option>
    </select>
</div>

<div class="form-group">
    <label class="form-label" id="titleLabel">üìù Title</label>
    <input type="text" id="customTitle" name="customTitle" class="form-input" placeholder="Leave empty to show city name" />
</div>

<div class="form-group">
    <label class="form-label" id="debugLabel">üêõ Debug Weather Alert</label>
    <div class="form-group">
        <input type="text" id="mockAlertHeadline" name="mockAlertHeadline" class="form-input" placeholder="Alert headline (leave empty for real alerts)" />
    </div>
    <div class="form-group">
        <span id="severityLabel">Severity:</span>
        <select id="mockAlertSeverity" name="mockAlertSeverity" class="form-input">
            <option value="">None (Use Real)</option>
            <option value="minor">Minor</option>
            <option value="moderate">Moderate</option>
            <option value="severe">Severe</option>
            <option value="extreme">Extreme</option>
        </select>
    </div>
</div>

<div class="form-group">
    <label for="displayMetrics" class="form-label" id="displayLabel">üëÅÔ∏è Display Options</label>

    <div class="form-group">
      <input type="checkbox" id="displayRefreshTime" name="displayRefreshTime" onclick="this.value=this.checked ? 'true' : 'false';">
      <span id="refreshTimeLabel">Refresh Time</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayMetrics" name="displayMetrics" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="metricsLabel">Metrics</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayGraph" name="displayGraph" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="graphLabel">Weather Graph</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayRain" name="displayRain" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="rainLabel">Rain Amount</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="mergeMinutelyData" name="mergeMinutelyData" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="mergeMinutelyDataLabel">Merge Minutely Precipitation</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="moonPhase" name="moonPhase" onclick="this.value=this.checked ? 'true' : 'false'; toggleAirQualityOption();">
        <span id="moonPhaseLabel">Moon Phase</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="showAirQuality" name="showAirQuality" onclick="this.value=this.checked ? 'true' : 'false'; toggleMoonPhaseOption();">
        <span id="showAirQualityLabel">Air Quality</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="temperatureBars" name="temperatureBars" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="temperatureBarsLabel">Temperature Bars</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayForecast" name="displayForecast" onclick="this.value=this.checked ? 'true' : 'false';">
        <span id="forecastLabel">Forecast</span>
        <select id="forecastDays" name="forecastDays" class="form-input">
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=7>7</option>
        </select>
        <span id="daysLabel">days</span>
    </div>
</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">√ó</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div class="form-group" style="display: flex; gap: 10px;">
            <input type="text" id="searchInput" placeholder="Search for a location..." class="form-input" style="flex: 1;" />
            <button type="button" id="searchButton" class="action-button compact">Search</button>
        </div>
        <div id="searchResults" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; margin-top: 5px; display: none;"></div>
        <div id="map" style="width: 100%; height: 300px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>
    // i18n translations
    const translations = {
        en: {
            languageLabel: 'üåê Language',
            locationLabel: 'üìç Location',
            latitudeLabel: 'Latitude',
            longitudeLabel: 'Longitude',
            selectLocation: 'Select Location',
            getLocationByIP: 'üìç Get Location by IP',
            selectOnMap: 'üó∫Ô∏è Select on Map',
            setAsDefault: '‚≠ê Set as Default',
            searchPlaceholder: 'Search for a location...',
            searchButton: 'Search',
            unitsLabel: 'üå°Ô∏è Units',
            themeModeLabel: 'üé® Theme Mode',
            themeLight: 'Light',
            themeDark: 'Dark',
            themeAuto: 'Auto (based on sunrise/sunset)',
            displayStyleLabel: 'üñºÔ∏è Display Style',
            styleDefault: 'Default',
            styleNothing: 'Nothing Weather (Pixel)',
            styleQweather: 'QWeather Official',
            titleLabel: 'üìù Title',
            titlePlaceholder: 'Leave empty to show city name',
            debugLabel: 'üêõ Debug Weather Alert',
            alertHeadlinePlaceholder: 'Alert headline (leave empty for real alerts)',
            severityLabel: 'Severity:',
            severityNone: 'None (Use Real)',
            severityMinor: 'Minor',
            severityModerate: 'Moderate',
            severitySevere: 'Severe',
            severityExtreme: 'Extreme',
            displayLabel: 'üëÅÔ∏è Display Options',
            refreshTimeLabel: 'Refresh Time',
            metricsLabel: 'Metrics',
            graphLabel: 'Weather Graph',
            rainLabel: 'Rain Amount',
            mergeMinutelyDataLabel: 'Merge Minutely Precipitation',
            moonPhaseLabel: 'Moon Phase',
            showAirQualityLabel: 'Air Quality',
            temperatureBarsLabel: 'Temperature Bars',
            forecastLabel: 'Forecast',
            daysLabel: 'days',
            modalTitle: 'Select Location',
            saveButton: 'Save',
            enterKeyword: 'Please enter a search keyword',
            noResults: 'No results found',
            mapLoadFailed: 'Map library failed to load. Please refresh the page.',
            mapCreateFailed: 'Failed to create map: '
        },
        zh: {
            languageLabel: 'üåê ËØ≠Ë®Ä',
            locationLabel: 'üìç ‰ΩçÁΩÆ',
            latitudeLabel: 'Á∫¨Â∫¶',
            longitudeLabel: 'ÁªèÂ∫¶',
            selectLocation: 'ÈÄâÊã©‰ΩçÁΩÆ',
            getLocationByIP: 'üìç ÈÄöËøáIPËé∑Âèñ‰ΩçÁΩÆ',
            selectOnMap: 'ÔøΩÂõæ Âú®Âú∞Âõæ‰∏äÈÄâÊã©',
            setAsDefault: '‚≠ê ËÆæ‰∏∫ÈªòËÆ§',
            searchPlaceholder: 'ÊêúÁ¥¢Âú∞ÁÇπ...',
            searchButton: 'ÊêúÁ¥¢',
            unitsLabel: 'üå°Ô∏è Âçï‰Ωç',
            themeModeLabel: 'üé® ‰∏ªÈ¢òÊ®°Âºè',
            themeLight: 'ÊµÖËâ≤',
            themeDark: 'Ê∑±Ëâ≤',
            themeAuto: 'Ëá™Âä®ÔºàÂü∫‰∫éÊó•Âá∫Êó•ËêΩÔºâ',
            displayStyleLabel: 'üñºÔ∏è ÊòæÁ§∫È£éÊ†º',
            styleDefault: 'ÈªòËÆ§',
            styleNothing: 'NothingÂ§©Ê∞îÔºàÂÉèÁ¥†È£éÔºâ',
            styleQweather: 'ÂíåÈ£éÂ§©Ê∞îÂÆòÊñπ',
            titleLabel: 'üìù Ê†áÈ¢ò',
            titlePlaceholder: 'ÁïôÁ©∫ÂàôÊòæÁ§∫ÂüéÂ∏ÇÂêçÁß∞',
            debugLabel: 'üêõ Ë∞ÉËØïÂ§©Ê∞îÈ¢ÑË≠¶',
            alertHeadlinePlaceholder: 'È¢ÑË≠¶Ê†áÈ¢òÔºàÁïôÁ©∫‰ΩøÁî®ÁúüÂÆûÈ¢ÑË≠¶Ôºâ',
            severityLabel: '‰∏•ÈáçÁ®ãÂ∫¶:',
            severityNone: 'Êó†Ôºà‰ΩøÁî®ÁúüÂÆûÔºâ',
            severityMinor: 'ËΩªÂæÆ',
            severityModerate: '‰∏≠Á≠â',
            severitySevere: '‰∏•Èáç',
            severityExtreme: 'ÊûÅÁ´Ø',
            displayLabel: 'üëÅÔ∏è ÊòæÁ§∫ÈÄâÈ°π',
            refreshTimeLabel: 'Âà∑Êñ∞Êó∂Èó¥',
            metricsLabel: 'Ê∞îË±°ÊåáÊ†á',
            graphLabel: 'Â§©Ê∞îÂõæË°®',
            rainLabel: 'ÈôçÊ∞¥Èáè',
            mergeMinutelyDataLabel: 'ÂêàÂπ∂ÂàÜÈíüÁ∫ßÈôçÊ∞¥Êï∞ÊçÆ',
            moonPhaseLabel: 'ÊúàÁõ∏',
            showAirQualityLabel: 'Á©∫Ê∞îË¥®Èáè',
            temperatureBarsLabel: 'Ê∏©Â∫¶Êù°',
            forecastLabel: 'Â§©Ê∞îÈ¢ÑÊä•',
            daysLabel: 'Â§©',
            modalTitle: 'ÈÄâÊã©‰ΩçÁΩÆ',
            saveButton: '‰øùÂ≠ò',
            enterKeyword: 'ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç',
            noResults: 'Êú™ÊâæÂà∞ÁªìÊûú',
            mapLoadFailed: 'Âú∞ÂõæÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢',
            mapCreateFailed: 'ÂàõÂª∫Âú∞ÂõæÂ§±Ë¥•Ôºö'
        }
    };
    let currentLang = 'zh'; // Default language

    function updateLanguage(lang) {
        console.log('Updating language to:', lang);
        currentLang = lang;
        const t = translations[lang];
        document.getElementById('languageLabel').textContent = t.languageLabel;
        document.getElementById('locationLabel').textContent = t.locationLabel;
        document.getElementById('latitudeLabel').textContent = t.latitudeLabel;
        document.getElementById('longitudeLabel').textContent = t.longitudeLabel;
        document.getElementById('getLocationByIP').textContent = t.getLocationByIP;
        document.getElementById('openMap').textContent = t.selectOnMap;
        document.getElementById('setDefault').textContent = t.setAsDefault;
        document.getElementById('searchInput').placeholder = t.searchPlaceholder;
        document.getElementById('searchButton').textContent = t.searchButton;
        document.getElementById('unitsLabel').textContent = t.unitsLabel;
        document.getElementById('themeModeLabel').textContent = t.themeModeLabel;
        document.getElementById('displayStyleLabel').textContent = t.displayStyleLabel;
        document.getElementById('titleLabel').textContent = t.titleLabel;
        document.getElementById('customTitle').placeholder = t.titlePlaceholder;
        document.getElementById('debugLabel').textContent = t.debugLabel;
        document.getElementById('mockAlertHeadline').placeholder = t.alertHeadlinePlaceholder;
        document.getElementById('severityLabel').textContent = t.severityLabel;
        document.getElementById('displayLabel').textContent = t.displayLabel;
        document.getElementById('refreshTimeLabel').textContent = t.refreshTimeLabel;
        document.getElementById('metricsLabel').textContent = t.metricsLabel;
        document.getElementById('graphLabel').textContent = t.graphLabel;
        document.getElementById('rainLabel').textContent = t.rainLabel;
        document.getElementById('mergeMinutelyDataLabel').textContent = t.mergeMinutelyDataLabel;
        document.getElementById('moonPhaseLabel').textContent = t.moonPhaseLabel;
        if (document.getElementById('showAirQualityLabel')) {
            document.getElementById('showAirQualityLabel').textContent = t.showAirQualityLabel;
        }
        document.getElementById('temperatureBarsLabel').textContent = t.temperatureBarsLabel;
        document.getElementById('forecastLabel').textContent = t.forecastLabel;
        document.getElementById('daysLabel').textContent = t.daysLabel;
        document.getElementById('modalTitle').textContent = t.modalTitle;
        document.getElementById('closeMap').textContent = t.saveButton;

        // Update theme mode options
        const themeOptions = document.querySelectorAll('#themeMode option');
        themeOptions[0].textContent = t.themeLight;
        themeOptions[1].textContent = t.themeDark;
        themeOptions[2].textContent = t.themeAuto;

        // Update display style options
        const styleOptions = document.querySelectorAll('#displayStyle option');
        styleOptions[0].textContent = t.styleDefault;
        styleOptions[1].textContent = t.styleNothing;
        styleOptions[2].textContent = t.styleQweather;

        // Update severity options
        const severityOptions = document.querySelectorAll('#mockAlertSeverity option');
        severityOptions[0].textContent = t.severityNone;
        severityOptions[1].textContent = t.severityMinor;
        severityOptions[2].textContent = t.severityModerate;
        severityOptions[3].textContent = t.severitySevere;
        document.getElementById('searchResults').style.display = 'none';
        severityOptions[4].textContent = t.severityExtreme;
    }

    function toggleAirQualityOption() {
        const moonPhaseCheckbox = document.getElementById('moonPhase');
        const airQualityCheckbox = document.getElementById('showAirQuality');
        if (moonPhaseCheckbox.checked) {
            airQualityCheckbox.checked = false;
            airQualityCheckbox.value = 'false';
        }
    }

    function toggleMoonPhaseOption() {
        const moonPhaseCheckbox = document.getElementById('moonPhase');
        const airQualityCheckbox = document.getElementById('showAirQuality');
        if (airQualityCheckbox.checked) {
            moonPhaseCheckbox.checked = false;
            moonPhaseCheckbox.value = 'false';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing...');

        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $closeMap = document.querySelector('#closeMap');
        const $language = document.querySelector('#language');
        const $getLocationByIP = document.querySelector('#getLocationByIP');
        const $setDefault = document.querySelector('#setDefault');
        const $searchInput = document.querySelector('#searchInput');
        const $searchResults = document.querySelector('#searchResults');

        console.log('Button elements found:', {
            getLocationByIP: !!$getLocationByIP,
            openMap: !!$openMap,
            setDefault: !!$setDefault
        });

        let latitude = +$latitude.value || 39.9042;
        let longitude = +$longitude.value || 116.4074;

        let map, marker;

        // Language change handler
        $language.addEventListener('change', (e) => {
            console.log('Language changed to:', e.target.value);
            updateLanguage(e.target.value);
        });

        // Get location by IP button
        $getLocationByIP.addEventListener('click', async (e) => {
            console.log('Get Location by IP button clicked');
            e.preventDefault();
            try {
                const response = await fetch('/api/amap/ip_location');
                const data = await response.json();
                console.log('IP location response:', data);

                if (data.success) {
                    $latitude.value = data.latitude;
                    $longitude.value = data.longitude;
                    latitude = data.latitude;
                    longitude = data.longitude;
                } else {
                    alert('Failed to get location: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error getting location: ' + error.message);
            }
        });

        // Set as default button
        $setDefault.addEventListener('click', async () => {
            const lat = parseFloat($latitude.value);
            const lng = parseFloat($longitude.value);

            if (!lat || !lng) {
                alert('Please set a valid location first');
                return;
            }

            try {
                const response = await fetch('/api/amap/save_default_location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Default location saved successfully!');
                } else {
                    alert('Failed to save default location: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving default location: ' + error.message);
            }
        });

        // Initialize Amap when opening modal
        $openMap.addEventListener('click', async (e) => {
            console.log('Open Map button clicked');
            e.preventDefault();

            openModal('mapModal');
            console.log('Map modal opened');

            // If no location set, try to get IP location first
            if (!latitude || !longitude || (latitude === 39.9042 && longitude === 116.4074)) {
                console.log('No location set, trying IP location...');
                try {
                    const response = await fetch('/api/amap/ip_location');
                    const data = await response.json();
                    console.log('IP location response:', data);
                    if (data.success) {
                        latitude = data.latitude;
                        longitude = data.longitude;
                        $latitude.value = latitude;
                        $longitude.value = longitude;
                        console.log('IP location obtained:', latitude, longitude);
                    }
                } catch (error) {
                    console.error('Failed to get IP location:', error);
                }
            } else {
                console.log('Using existing location:', latitude, longitude);
            }

            setTimeout(() => {
                console.log('Initializing map with center:', longitude, latitude);

                if (!map) {
                    console.log('Creating new map instance...');

                    // Use the recommended loader method for Amap v2.0
                    window.AMapLoader.load({
                            key: "92cd06d2544958bb607195395e62eeb9",
                            version: "2.0",
                            plugins: ["AMap.PlaceSearch"]
                        }).then(AMap => {
                            console.log('AMap loaded successfully');

                            // Initialize Amap
                            map = new AMap.Map('map', {
                                zoom: 12,
                                center: [longitude, latitude],
                                viewMode: '2D',
                                resizeEnable: true
                            });

                        console.log('Map created successfully');

                        // Add marker
                        marker = new AMap.Marker({
                            position: [longitude, latitude],
                            draggable: true
                        });
                        map.add(marker);
                        console.log('Marker added');

                        // Update coordinates when marker is dragged
                        marker.on('dragend', (e) => {
                            const position = marker.getPosition();
                            latitude = position.lat;
                            longitude = position.lng;
                            console.log('Marker dragged to:', latitude, longitude);
                        });

                        // Add marker on map click
                        map.on('click', (e) => {
                            const lnglat = e.lnglat;
                            marker.setPosition([lnglat.lng, lnglat.lat]);
                            latitude = lnglat.lat;
                            longitude = lnglat.lng;
                            console.log('Map clicked, marker moved to:', latitude, longitude);
                        });

                        // Initialize PlaceSearch for search button
                        const placeSearch = new AMap.PlaceSearch({
                            pageSize: 10
                        });

                        console.log('PlaceSearch initialized');

                        // Search button handler
                        const $searchButton = document.querySelector('#searchButton');
                        $searchButton.addEventListener('click', () => {
                            const keyword = $searchInput.value.trim();
                            console.log('Search clicked, keyword:', keyword);

                            if (!keyword) {
                                alert(translations[currentLang].enterKeyword);
                                return;
                            }

                            placeSearch.search(keyword, (status, result) => {
                                console.log('Search status:', status);
                                console.log('Search result:', result);

                                if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                                    const pois = result.poiList.pois;
                                    console.log('Found', pois.length, 'results');

                                    // Show search results
                                    $searchResults.innerHTML = '';
                                    $searchResults.style.display = 'block';

                                    pois.forEach((poi, index) => {
                                        const div = document.createElement('div');
                                        div.style.padding = '8px';
                                        div.style.cursor = 'pointer';
                                        div.style.borderBottom = '1px solid #eee';
                                        div.textContent = `${poi.name} - ${poi.address || ''}`;

                                        div.addEventListener('click', () => {
                                            const location = poi.location;
                                            console.log('Selected POI:', poi.name, location.lng, location.lat);
                                            map.setCenter([location.lng, location.lat]);
                                            map.setZoom(15);
                                            marker.setPosition([location.lng, location.lat]);
                                            latitude = location.lat;
                                            longitude = location.lng;
                                            $searchResults.style.display = 'none';
                                            $searchInput.value = poi.name;
                                        });

                                        $searchResults.appendChild(div);
                                    });
                                } else {
                                    console.warn('No results found or search failed');
                                    alert(translations[currentLang].noResults);
                                }
                            });
                        });

                        // Allow Enter key to trigger search
                        $searchInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                console.log('Enter key pressed');
                                $searchButton.click();
                            }
                        });
                    }).catch(error => {
                        console.error('Error loading Amap:', error);
                        alert(translations[currentLang].mapLoadFailed + ': ' + error.message);
                    });
                } else {
                    console.log('Map already exists, updating center');
                    // Map already exists, just update center
                    map.setCenter([longitude, latitude]);
                    marker.setPosition([longitude, latitude]);
                }
            }, 500); // Increased timeout to 500ms
        });

        // Save location when closing map
        $closeMap.addEventListener('click', () => {
            $latitude.value = latitude.toFixed(6);
            $longitude.value = longitude.toFixed(6);
            closeModal('mapModal');
        });

        // Load settings
        console.log('Loading plugin settings...');
        try {
            if ( typeof loadPluginSettings !== 'undefined' && loadPluginSettings) {
                document.getElementById('latitude').value = pluginSettings.latitude || '39.9042';
                document.getElementById('longitude').value = pluginSettings.longitude || '116.4074';
                document.getElementById('units').value = pluginSettings.units || 'metric';
                document.getElementById('language').value = pluginSettings.language || 'zh';
                document.getElementById('themeMode').value = pluginSettings.themeMode || 'auto';
                document.getElementById('displayStyle').value = pluginSettings.displayStyle || 'default';

                document.getElementById('displayRefreshTime').checked = pluginSettings.displayRefreshTime === 'true' || pluginSettings.displayRefreshTime === true;
                document.getElementById('displayRefreshTime').value = (pluginSettings.displayRefreshTime !== undefined && pluginSettings.displayRefreshTime !== null) ? pluginSettings.displayRefreshTime : 'true';

                document.getElementById('displayMetrics').checked = pluginSettings.displayMetrics === 'true' || pluginSettings.displayMetrics === true;
                document.getElementById('displayMetrics').value = (pluginSettings.displayMetrics !== undefined && pluginSettings.displayMetrics !== null) ? pluginSettings.displayMetrics : 'true';

                document.getElementById('displayGraph').checked = pluginSettings.displayGraph === 'true' || pluginSettings.displayGraph === true;
                document.getElementById('displayGraph').value = (pluginSettings.displayGraph !== undefined && pluginSettings.displayGraph !== null) ? pluginSettings.displayGraph : 'true';

                document.getElementById('displayRain').checked = pluginSettings.displayRain === 'true' || pluginSettings.displayRain === true;
                document.getElementById('displayRain').value = (pluginSettings.displayRain !== undefined && pluginSettings.displayRain !== null) ? pluginSettings.displayRain : 'true';

                document.getElementById('mergeMinutelyData').checked = pluginSettings.mergeMinutelyData === 'true' || pluginSettings.mergeMinutelyData === true;
                document.getElementById('mergeMinutelyData').value = (pluginSettings.mergeMinutelyData !== undefined && pluginSettings.mergeMinutelyData !== null) ? pluginSettings.mergeMinutelyData : 'false';

                document.getElementById('displayForecast').checked = pluginSettings.displayForecast === 'true' || pluginSettings.displayForecast === true;
                document.getElementById('displayForecast').value = (pluginSettings.displayForecast !== undefined && pluginSettings.displayForecast !== null) ? pluginSettings.displayForecast : 'true';

                document.getElementById('forecastDays').value = pluginSettings.forecastDays || 7;

                document.getElementById('moonPhase').checked = pluginSettings.moonPhase === 'true' || pluginSettings.moonPhase === true;
                document.getElementById('moonPhase').value = (pluginSettings.moonPhase !== undefined && pluginSettings.moonPhase !== null) ? pluginSettings.moonPhase : 'false';

                document.getElementById('showAirQuality').checked = pluginSettings.showAirQuality === 'true' || pluginSettings.showAirQuality === true;
                document.getElementById('showAirQuality').value = (pluginSettings.showAirQuality !== undefined && pluginSettings.showAirQuality !== null) ? pluginSettings.showAirQuality : 'false';

                document.getElementById('temperatureBars').checked = pluginSettings.temperatureBars === 'true' || pluginSettings.temperatureBars === true;
                document.getElementById('temperatureBars').value = (pluginSettings.temperatureBars !== undefined && pluginSettings.temperatureBars !== null) ? pluginSettings.temperatureBars : 'true';

                document.getElementById('customTitle').value = pluginSettings.customTitle || '';

                document.getElementById('mockAlertHeadline').value = pluginSettings.mockAlertHeadline || '';
                document.getElementById('mockAlertSeverity').value = pluginSettings.mockAlertSeverity || '';

                // Update language UI - default to Chinese if no saved setting
                const savedLang = pluginSettings.language || 'zh';
                document.getElementById('language').value = savedLang;
                updateLanguage(savedLang);
            } else {
                // Default settings for development mode
                document.getElementById('latitude').value = '39.9042';
                document.getElementById('longitude').value = '116.4074';
                document.getElementById('units').value = "metric";
                document.getElementById('language').value = "zh";
                document.getElementById('themeMode').value = "auto";
                document.getElementById('displayStyle').value = "default";
                document.getElementById('displayRefreshTime').checked = true;
                document.getElementById('displayRefreshTime').value = "true";
                document.getElementById('displayMetrics').checked = true;
                document.getElementById('displayMetrics').value = "true";
                document.getElementById('displayGraph').checked = true;
                document.getElementById('displayGraph').value = "true";
                document.getElementById('displayRain').checked = true;
                document.getElementById('displayRain').value = "true";
                document.getElementById('mergeMinutelyData').checked = false;
                document.getElementById('mergeMinutelyData').value = "false";
                document.getElementById('displayForecast').checked = true;
                document.getElementById('displayForecast').value = "true";
                document.getElementById('forecastDays').value = 7;
                document.getElementById('moonPhase').checked = false;
                document.getElementById('moonPhase').value = "false";
                document.getElementById('showAirQuality').checked = true;
                document.getElementById('showAirQuality').value = "true";
                document.getElementById('temperatureBars').checked = true;
                document.getElementById('temperatureBars').value = "true";
                document.getElementById('customTitle').value = '';

                document.getElementById('mockAlertHeadline').value = '';
                document.getElementById('mockAlertSeverity').value = '';

                // Initialize with Chinese
                updateLanguage('zh');
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });
</script>
